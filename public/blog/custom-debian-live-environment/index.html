<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Create a Custom Debian Live Environment (CD or USB) - Will Haley</title>

  <meta name="author" content="will">
  <meta name="description" content="These are steps that I used on an Ubuntu 18.04 LTS (Bionic Beaver) 64-bit system to build an x86 Debian 9 (Stretch) live environment that I can boot from CD or ...">

  <link rel="stylesheet" href="/css/main.css?version=1.1.6">
  <link rel="stylesheet" href="/css/custom.css?version=1.1.6">
  <link rel="canonical" href="http://willhaley.com/blog/custom-debian-live-environment/">

  <link rel="manifest" href="/manifest.json?version=1.1.6">

  <link rel="shortcut icon" href="/favicon.ico?version=1.1.6">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png?version=1.1.6">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png?version=1.1.6">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png?version=1.1.6">
  <link rel="mask-icon" href="/favicon/safari-pinned-tab.svg?version=1.1.6">
  <meta name="msapplication-config" content="/browserconfig.xml?version=1.1.6">
  <meta name="theme-color" content="#ffffff">
</head>

<body>
  <header class="site-header" role="banner">
    <div class="wrapper" id="app">

      <a class="site-title" href="/">Will Haley</a>

      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger">
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"></path>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"></path>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"></path>
            </svg>
          </span>
        </label>

        <div class="trigger">
          <a class="page-link" href="/about/">About</a>
          <a class="page-link" href="/clippings/">Clippings</a>
          <a class="page-link" href="/favorites/">Favorites</a>
          <a class="page-link" href="/cv/">CV</a>
        </div>
      </nav>
    </div>
  </header>

  <main class="page-content" aria-label="Content">
    <div class="wrapper">
      
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Create a Custom Debian Live Environment (CD or USB)</h1>
    <p class="post-meta"><time datetime="2018-02-08T18:36:00+00:00" itemprop="datePublished">Feb 8, 2018</time><span class="date-modified">Updated <time datetime="2018-05-26T12:30:00+00:00" itemprop="dateModified">May 26, 2018</time></span></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    

<p>These are steps that I used on an <strong>Ubuntu 18.04 LTS (Bionic Beaver)</strong> 64-bit system to build an <strong>x86 Debian 9 (Stretch)</strong> live environment that I can boot from CD or USB.</p>

<p>These steps can be used to create a live environment that is BIOS bootable (MBR), UEFI bootable (GPT), or combination of both UEFI and BIOS bootable. Something unique about this guide is that <strong>Syslinux/Isolinux are not used. Only Grub boot equipment.</strong> This is done for consistency and to avoid mixing the two (Syslinux/Isolinux alone cannot accomplish everything covered in this article, but Grub can).</p>

<p>Here are some alternatives to my guide that may be better solutions for anyone reading this article: <a href="https://manpages.debian.org/jessie/live-build/live-build.7.en.html">live-build</a>, <a href="https://help.ubuntu.com/community/mkusb">mkusb</a>, <a href="https://unetbootin.github.io/">UNetbootin</a>, <a href="https://github.com/jnalley/xixer">xixer</a>, <a href="https://rufus.akeo.ie/">rufus</a>, <a href="https://www.pendrivelinux.com/yumi-multiboot-usb-creator/">YUMI</a>, <a href="https://wiki.debian.org/Simple-CDD">Simple-cdd</a>. You should also look at the <a href="https://wiki.debian.org/DebianCustomCD">Debian DebianCustomCD documentation</a> as it will prove more informative than this article could ever be.</p>

<p>I wrote this guide more for educational purposes than anything. It is not necessarily the fastest guide or the best guide for your needs. I hope it is helpful all the same.</p>

<!-- more -->

<p><strong><span class="warning">Warning</span></strong>: I have <strong><span class="warning">highlighted</span></strong> all the places you should be in the <strong><span class="warning">[chroot]</span></strong> environment. Be careful! Running some of these commands on your local environment instead of in the <a href="https://en.wikipedia.org/wiki/Chroot">chroot</a> can damage your system.</p>

<h1 id="prerequisites">Prerequisites</h1>

<p>Install applications we need to build the environment.</p>

<pre><code>sudo apt-get install \
    debootstrap \
    squashfs-tools \
    xorriso \
    grub-pc-bin \
    grub-efi-amd64-bin \
    mtools
</code></pre>

<p>Create a directory where we will store all of the files we create throughout this guide.</p>

<pre><code>mkdir $HOME/LIVE_BOOT
</code></pre>

<h1 id="bootstrap-and-configure-debian">Bootstrap and Configure Debian</h1>

<p>Set up the base Debian environment. I am using <code>stretch</code> for my distribution and <code>i386</code> for the architecture. Consult the list of <a href="https://www.debian.org/mirror/list">debian mirrors</a>.</p>

<p><em>Please change the URL in this command if there is a mirror that is closer to you.</em></p>

<pre><code>sudo debootstrap \
    --arch=i386 \
    --variant=minbase \
    stretch \
    $HOME/LIVE_BOOT/chroot \
    http://ftp.us.debian.org/debian/
</code></pre>

<p>Chroot to the Debian environment we just bootstrapped.</p>

<pre><code>sudo chroot $HOME/LIVE_BOOT/chroot
</code></pre>

<p><strong><span class="warning">[chroot]</span></strong> Set a custom hostname for your Debian environment.</p>

<pre><code>echo &quot;debian-live&quot; &gt; /etc/hostname
</code></pre>

<p><strong><span class="warning">[chroot]</span></strong> Figure out which Linux Kernel you want in the live environment.</p>

<pre><code>apt-cache search linux-image
</code></pre>

<p><strong><span class="warning">[chroot]</span></strong> I chose the image <code>linux-image-686</code>. I also believe <code>live-boot</code> is a necessity. <code>systemd-sys</code> (or an equivalent) is also necessary to provide init.</p>

<pre><code>apt-get update &amp;&amp; \
apt-get install --no-install-recommends \
    linux-image-686 \
    live-boot \
    systemd-sysv
</code></pre>

<p><strong><span class="warning">[chroot]</span></strong> Install programs of your choosing, and then run <code>apt-get clean</code> to save some space. I use <code>--no-install-recommends</code> to avoid superfluous packages. You should decide what you need for your environment.</p>

<p>Read Debian&rsquo;s <a href="https://wiki.debian.org/ReduceDebian">ReduceDebian article</a> for tips on reducing the size of your Debian environment if size is important and you want a minimal and compact installation. Please note that some live environments like <a href="https://en.wikipedia.org/wiki/Tiny_Core_Linux">Tiny Core Linux</a> or <a href="https://en.wikipedia.org/wiki/Puppy_Linux">Puppy Linux</a> are specifically optimized for a tiny footprint. Although this article results in a relatively tiny live environment, generating an environment that is only a couple dozen MB large takes additional effort not covered in this article.</p>

<pre><code>apt-get install --no-install-recommends \
    network-manager net-tools wireless-tools wpagui \
    curl openssh-client \
    blackbox xserver-xorg-core xserver-xorg xinit xterm \
    nano &amp;&amp; \
apt-get clean
</code></pre>

<p><strong><span class="warning">[chroot]</span></strong> Set the root password. <code>root</code> will be the only user in this live environment by default, but you may add additional users as needed.</p>

<pre><code>passwd root
</code></pre>

<p><strong><span class="warning">[chroot]</span></strong> Exit the chroot.</p>

<pre><code>exit
</code></pre>

<p>Create directories that will contain files for our live environment files and scratch files.</p>

<pre><code>mkdir -p $HOME/LIVE_BOOT/{scratch,image/live}
</code></pre>

<p>Compress the chroot environment into a Squash filesystem.</p>

<pre><code>sudo mksquashfs \
    $HOME/LIVE_BOOT/chroot \
    $HOME/LIVE_BOOT/image/live/filesystem.squashfs \
    -e boot
</code></pre>

<p>Copy the kernel and initramfs from inside the <code>chroot</code> to the <code>live</code> directory.</p>

<pre><code>cp $HOME/LIVE_BOOT/chroot/boot/vmlinuz-* \
    $HOME/LIVE_BOOT/image/vmlinuz &amp;&amp; \
cp $HOME/LIVE_BOOT/chroot/boot/initrd.img-* \
    $HOME/LIVE_BOOT/image/initrd
</code></pre>

<p>Create a menu configuration file for grub. Please note that the <code>insmod all_video</code> line was needed in my testing to deal with <a href="https://askubuntu.com/a/857008/413290">a bug in UEFI booting</a> for one of my machines. Perhaps not everyone will need that line, but I did.</p>

<p>This config instructs Grub to use the <code>search</code> command to infer which device contains our live environment. This seems like the most portable solution considering the various ways we may write our live environment to bootable media.</p>

<pre><code>cat &lt;&lt;'EOF' &gt;$HOME/LIVE_BOOT/scratch/grub.cfg

search --set=root --file /DEBIAN_CUSTOM

insmod all_video

set default=&quot;0&quot;
set timeout=30

menuentry &quot;Debian Live&quot; {
    linux /vmlinuz boot=live quiet nomodeset
    initrd /initrd
}
EOF
</code></pre>

<p>Create a special file in <code>image</code> named <code>DEBIAN_CUSTOM</code>. This file will be used to help <code>Grub</code> figure out which device contains our live filesystem. This file name must be unique and must match the file name in our <code>grub.cfg</code> config.</p>

<pre><code>touch $HOME/LIVE_BOOT/image/DEBIAN_CUSTOM
</code></pre>

<p>Your <code>LIVE_BOOT</code> directory should now roughly look like this.</p>

<pre><code>LIVE_BOOT/chroot/*tons of chroot files*
LIVE_BOOT/scratch/grub.cfg
LIVE_BOOT/image/DEBIAN_CUSTOM
LIVE_BOOT/image/initrd
LIVE_BOOT/image/vmlinuz
LIVE_BOOT/image/live/filesystem.squashfs
</code></pre>

<h1 id="create-a-bootable-medium">Create a bootable medium</h1>

<p>Please note that there are two <strong>separate</strong> sets of instructions below for creating a bootable medium for the live environment. One process is titled <a href="#create-bootable-iso-cd">Create Bootable ISO/CD</a> and the other, <strong>separate process</strong>, is titled <a href="#create-bootable-usb">Create Bootable USB</a>.</p>

<ul>
<li>The <strong>Create Bootable ISO/CD</strong> instructions will result in an <code>.iso</code> image file containing our live environment.</li>
<li>The <strong>Create Bootable USB</strong> instructions will result in our live environment being installed directly to a USB device.</li>
</ul>

<p>The <code>.iso</code> file we create with the <strong>Create Bootable ISO/CD</strong> instructions can be burned to a CD-ROM (optical media), or written to a USB device with <code>dd</code>. The functionality that allows this &ldquo;dd-able&rdquo; behavior from our <code>.iso</code> file does <em>not</em> come for free. The process is a bit complex, but that resultant behavior is common in many modern live environments such as the Ubuntu installation <code>.iso</code> file.</p>

<p><em>Please note that writing an <code>.iso</code> file to a USB device is <strong>not</strong> the same as installing the live environment directly to a USB device. Read more in my <a href="#notes">Notes</a> which details my discoveries.</em></p>

<h2 id="create-bootable-iso-cd">Create Bootable ISO/CD</h2>

<p>Install the live environment to an <code>.iso</code> file which can be burned to optical media.</p>

<p>As stated above, the <code>.iso</code> file generated by these steps <strong>can</strong> be written to a USB device with something like <code>dd</code>.</p>

<p><em>I have separated the instructions for creating a BIOS bootable, UEFI bootable, or combination BIOS + UEFI bootable <code>.iso</code> in order to illustrate the separate processes. <strong>Click either &ldquo;BIOS&rdquo;, &ldquo;UEFI&rdquo;, or &ldquo;BIOS + UEFI&rdquo; and follow the instructions that are appropriate for your needs.</strong></em></p>

<div class="tabs">
  <nav><div data-selected="true">BIOS</div><div>UEFI</div><div>BIOS &#43; UEFI</div></nav>
  <section>
    <div class="tab" data-selected="true" >
  <p>Create a grub BIOS image.</p>

<pre><code>grub-mkstandalone \
    --format=i386-pc \
    --output=$HOME/LIVE_BOOT/scratch/core.img \
    --install-modules=&quot;linux normal iso9660 biosdisk memdisk search tar ls&quot; \
    --modules=&quot;linux normal iso9660 biosdisk search&quot; \
    --locales=&quot;&quot; \
    --fonts=&quot;&quot; \
    &quot;boot/grub/grub.cfg=$HOME/LIVE_BOOT/scratch/grub.cfg&quot;
</code></pre>

<p>Use <code>cat</code> to combine a bootable Grub <code>cdboot.img</code> bootloader with our boot image.</p>

<pre><code>cat \
    /usr/lib/grub/i386-pc/cdboot.img \
    $HOME/LIVE_BOOT/scratch/core.img \
&gt; $HOME/LIVE_BOOT/scratch/bios.img
</code></pre>

<p>Generate the ISO file.</p>

<pre><code>xorriso \
    -as mkisofs \
    -iso-level 3 \
    -full-iso9660-filenames \
    -volid &quot;DEBIAN_CUSTOM&quot; \
    --grub2-boot-info \
    --grub2-mbr /usr/lib/grub/i386-pc/boot_hybrid.img \
    -eltorito-boot \
        boot/grub/bios.img \
        -no-emul-boot \
        -boot-load-size 4 \
        -boot-info-table \
        --eltorito-catalog boot/grub/boot.cat \
    -output &quot;${HOME}/LIVE_BOOT/debian-custom.iso&quot; \
    -graft-points \
        &quot;${HOME}/LIVE_BOOT/image&quot; \
        /boot/grub/bios.img=$HOME/LIVE_BOOT/scratch/bios.img
</code></pre>

<p>Now burn the ISO to a CD and you should be ready to boot from it using a BIOS system.</p>

</div>

<div class="tab"  >
  <p>Create a grub UEFI image.</p>

<pre><code>grub-mkstandalone \
    --format=x86_64-efi \
    --output=$HOME/LIVE_BOOT/scratch/bootx64.efi \
    --locales=&quot;&quot; \
    --fonts=&quot;&quot; \
    &quot;boot/grub/grub.cfg=$HOME/LIVE_BOOT/scratch/grub.cfg&quot;
</code></pre>

<p>Create a FAT16 UEFI boot disk image containing the EFI bootloader. Note the use of the <code>mmd</code> and <code>mcopy</code> commands to copy our UEFI boot loader named <code>bootx64.efi</code>.</p>

<pre><code>(cd $HOME/LIVE_BOOT/scratch &amp;&amp; \
    dd if=/dev/zero of=efiboot.img bs=1M count=10 &amp;&amp; \
    mkfs.vfat efiboot.img &amp;&amp; \
    mmd -i efiboot.img efi efi/boot &amp;&amp; \
    mcopy -i efiboot.img ./bootx64.efi ::efi/boot/
)
</code></pre>

<p>Generate the ISO file.</p>

<pre><code>xorriso \
    -as mkisofs \
    -iso-level 3 \
    -full-iso9660-filenames \
    -volid &quot;DEBIAN_CUSTOM&quot; \
    -eltorito-alt-boot \
        -e EFI/efiboot.img \
        -no-emul-boot \
    -append_partition 2 0xef ${HOME}/LIVE_BOOT/scratch/efiboot.img \
    -output &quot;${HOME}/LIVE_BOOT/debian-custom.iso&quot; \
    -graft-points \
        &quot;${HOME}/LIVE_BOOT/image&quot; \
        /EFI/efiboot.img=$HOME/LIVE_BOOT/scratch/efiboot.img
</code></pre>

<p>Now burn the ISO to a CD and you should be ready to boot from it using a UEFI system.</p>

</div>

<div class="tab"  >
  <p>Create a grub UEFI image.</p>

<pre><code>grub-mkstandalone \
    --format=x86_64-efi \
    --output=$HOME/LIVE_BOOT/scratch/bootx64.efi \
    --locales=&quot;&quot; \
    --fonts=&quot;&quot; \
    &quot;boot/grub/grub.cfg=$HOME/LIVE_BOOT/scratch/grub.cfg&quot;
</code></pre>

<p>Create a FAT16 UEFI boot disk image containing the EFI bootloader. Note the use of the <code>mmd</code> and <code>mcopy</code> commands to copy our UEFI boot loader named <code>bootx64.efi</code>.</p>

<pre><code>(cd $HOME/LIVE_BOOT/scratch &amp;&amp; \
    dd if=/dev/zero of=efiboot.img bs=1M count=10 &amp;&amp; \
    mkfs.vfat efiboot.img &amp;&amp; \
    mmd -i efiboot.img efi efi/boot &amp;&amp; \
    mcopy -i efiboot.img ./bootx64.efi ::efi/boot/
)
</code></pre>

<p>Create a grub BIOS image.</p>

<pre><code>grub-mkstandalone \
    --format=i386-pc \
    --output=$HOME/LIVE_BOOT/scratch/core.img \
    --install-modules=&quot;linux normal iso9660 biosdisk memdisk search tar ls&quot; \
    --modules=&quot;linux normal iso9660 biosdisk search&quot; \
    --locales=&quot;&quot; \
    --fonts=&quot;&quot; \
    &quot;boot/grub/grub.cfg=$HOME/LIVE_BOOT/scratch/grub.cfg&quot;
</code></pre>

<p>Use <code>cat</code> to combine a bootable Grub <code>cdboot.img</code> bootloader with our boot image.</p>

<pre><code>cat \
    /usr/lib/grub/i386-pc/cdboot.img \
    $HOME/LIVE_BOOT/scratch/core.img \
&gt; $HOME/LIVE_BOOT/scratch/bios.img
</code></pre>

<p>Generate the ISO file.</p>

<pre><code>xorriso \
    -as mkisofs \
    -iso-level 3 \
    -full-iso9660-filenames \
    -volid &quot;DEBIAN_CUSTOM&quot; \
    -eltorito-boot \
        boot/grub/bios.img \
        -no-emul-boot \
        -boot-load-size 4 \
        -boot-info-table \
        --eltorito-catalog boot/grub/boot.cat \
    --grub2-boot-info \
    --grub2-mbr /usr/lib/grub/i386-pc/boot_hybrid.img \
    -eltorito-alt-boot \
        -e EFI/efiboot.img \
        -no-emul-boot \
    -append_partition 2 0xef ${HOME}/LIVE_BOOT/scratch/efiboot.img \
    -output &quot;${HOME}/LIVE_BOOT/debian-custom.iso&quot; \
    -graft-points \
        &quot;${HOME}/LIVE_BOOT/image&quot; \
        /boot/grub/bios.img=$HOME/LIVE_BOOT/scratch/bios.img \
        /EFI/efiboot.img=$HOME/LIVE_BOOT/scratch/efiboot.img
</code></pre>

<p>Now burn the ISO to a CD and you should be ready to boot from it using either a UEFI or a BIOS system.</p>

</div>

  </section>
</div>
<script>

document.querySelectorAll('.tabs').forEach(($tabs) => {

    
    $tabs.querySelectorAll('nav div').forEach(($button) => {

        
        $button.addEventListener('click', function () {
            let selectedIndex = 0;

            
            $tabs.querySelectorAll('nav div').forEach(($otherButton, index) => {
                if ($otherButton !== $button) {
                    delete $otherButton.dataset.selected;
                } else {
                    selectedIndex = index;
                    $button.dataset.selected = true;
                }
            });

            
            $tabs.querySelectorAll('.tab').forEach(($otherTab, index) => {
                if (index != selectedIndex) {
                    delete $otherTab.dataset.selected;
                } else {
                    $otherTab.dataset.selected = true;
                }
            });
        });
    });
});
</script>

<h2 id="create-bootable-usb">Create Bootable USB</h2>

<p>Install the live environment to a USB device.</p>

<p>As stated above, installing a live environment to a USB device is <strong>not</strong> the same as writing an <code>.iso</code> file to a USB device. The end result is the same for the most part in both those scenarios, but there are subtle differences worth understanding, and there are valid reasons someone may want to install a live environment directly to a USB device rather than writing an <code>.iso</code> file to a USB device.</p>

<p><em>I have separated the instructions for creating a BIOS bootable, UEFI bootable, or combination BIOS + UEFI bootable USB device in order to illustrate the separate processes. <strong>Click either &ldquo;BIOS&rdquo;, &ldquo;UEFI&rdquo;, or &ldquo;BIOS + UEFI&rdquo; and follow the instructions that are appropriate for your needs.</strong></em></p>

<div class="tabs">
  <nav><div data-selected="true">BIOS</div><div>UEFI</div><div>BIOS &#43; UEFI</div></nav>
  <section>
    <div class="tab" data-selected="true" >
  <p>I am assuming you have an umounted <strong>blank</strong> USB drive at <strong>/dev/sdz</strong>.  To allow easily swapping in a real block device, I am using a variable named <code>$disk</code> in these commands.</p>

<p>Export the <code>disk</code> variable.</p>

<pre><code>export disk=/dev/sdz
</code></pre>

<p>Create a mount point for the USB drive.</p>

<pre><code>sudo mkdir -p /mnt/usb
</code></pre>

<p>Partition the USB drive using <code>parted</code>. This command creates 1 partition in a traditional MBR layout.</p>

<pre><code>sudo parted --script $disk \
    mklabel msdos \
    mkpart primary fat32 1MiB 100%
</code></pre>

<p>Format the partition.</p>

<pre><code>sudo mkfs.vfat -F32 ${disk}1
</code></pre>

<p>Mount the partition.</p>

<pre><code>sudo mount ${disk}1 /mnt/usb
</code></pre>

<p>Install Grub for i386-pc booting.</p>

<pre><code>sudo grub-install \
    --target=i386-pc \
    --boot-directory=/mnt/usb/boot \
    --recheck \
    $disk
</code></pre>

<p>Create a <code>live</code> directory on the USB device.</p>

<pre><code>sudo mkdir -p /mnt/usb/{boot/grub,live}
</code></pre>

<p>Copy the Debian live environment files we previously generated to the USB disk.</p>

<pre><code>sudo cp -r $HOME/LIVE_BOOT/image/* /mnt/usb/
</code></pre>

<p>Copy the <code>grub.cfg</code> boot configuration to the USB device.</p>

<pre><code>sudo cp \
    $HOME/LIVE_BOOT/scratch/grub.cfg \
    /mnt/usb/boot/grub/grub.cfg
</code></pre>

<p>Now unmount the disk and you should be ready to boot from it on a BIOS system.</p>

<pre><code>sudo umount /mnt/usb
</code></pre>

</div>

<div class="tab"  >
  <p>I am assuming you have an umounted <strong>blank</strong> USB drive at <strong>/dev/sdz</strong>. To allow easily swapping in a real block device, I am using a variable named <code>$disk</code> in these commands.</p>

<p>Export the <code>disk</code> variable.</p>

<pre><code>export disk=/dev/sdz
</code></pre>

<p>Create some mount points for the USB drive.</p>

<pre><code>sudo mkdir -p /mnt/{usb,efi}
</code></pre>

<p>Partition the USB drive using <code>parted</code>. This command creates 2 partitions in a GPT (Guid Partition Table) layout. One partition for UEFI, and one for our Debian OS and other live data.</p>

<pre><code>sudo parted --script $disk \
    mklabel gpt \
    mkpart ESP fat32 1MiB 200MiB \
        name 1 EFI \
        set 1 esp on \
    mkpart primary fat32 200MiB 100% \
        name 2 LINUX \
        set 2 msftdata on
</code></pre>

<p>Format the UEFI and data partitions.</p>

<pre><code>sudo mkfs.vfat -F32 ${disk}1 &amp;&amp; \
sudo mkfs.vfat -F32 ${disk}2
</code></pre>

<p>Mount the partitions.</p>

<pre><code>sudo mount ${disk}1 /mnt/efi &amp;&amp; \
sudo mount ${disk}2 /mnt/usb
</code></pre>

<p>Install Grub for x86_64 UEFI booting.</p>

<pre><code>sudo grub-install \
    --target=x86_64-efi \
    --efi-directory=/mnt/efi \
    --boot-directory=/mnt/usb/boot \
    --removable \
    --recheck
</code></pre>

<p>Create a <code>live</code> directory on the USB device.</p>

<pre><code>sudo mkdir -p /mnt/usb/{boot/grub,live}
</code></pre>

<p>Copy the Debian live environment files we previously generated to the USB disk.</p>

<pre><code>sudo cp -r $HOME/LIVE_BOOT/image/* /mnt/usb/
</code></pre>

<p>Copy the <code>grub.cfg</code> boot configuration to the USB device.</p>

<pre><code>sudo cp \
    $HOME/LIVE_BOOT/scratch/grub.cfg \
    /mnt/usb/boot/grub/grub.cfg
</code></pre>

<p>Now unmount the disk and you should be ready to boot from it on a UEFI system.</p>

<pre><code>sudo umount /mnt/{usb,efi}
</code></pre>

</div>

<div class="tab"  >
  <p>I am assuming you have an umounted <strong>blank</strong> USB drive at <strong>/dev/sdz</strong>. To allow easily swapping in a real block device, I am using a variable named <code>$disk</code> in these commands.</p>

<p>Export the <code>disk</code> variable.</p>

<pre><code>export disk=/dev/sdz
</code></pre>

<p>Create some mount points for the USB drive.</p>

<pre><code>sudo mkdir -p /mnt/{usb,efi}
</code></pre>

<p>Partition the USB drive using <code>parted</code>. This command creates 3 partitions in a GPT (Guid Partition Table) layout. One partition for the BIOS boot record, one for UEFI, and one for our Debian OS and other live data.</p>

<pre><code>sudo parted --script $disk \
    mklabel gpt \
    mkpart primary fat32 2048s 4095s \
        name 1 BIOS \
        set 1 bios_grub on \
    mkpart ESP fat32 4096s 413695s \
        name 2 EFI \
        set 2 esp on \
    mkpart primary fat32 413696s 100% \
        name 3 LINUX \
        set 3 msftdata on
</code></pre>

<p>Generate a hybrid MBR for the USB device. Note, this is non-standard and so may not work on all systems. The <a href="https://tails.boum.org/blueprint/usb_install_and_upgrade/gpt/">only</a> <a href="https://wiki.gentoo.org/wiki/Hybrid_partition_table">guides</a> <a href="https://wiki.archlinux.org/index.php/Multiboot_USB_drive#Hybrid_UEFI_GPT_.2B_BIOS_GPT.2FMBR_boot">I&rsquo;ve</a> found on hybrid MBRs show that it must be done with <code>gdisk</code>. <code>gdisk</code> supports commands <a href="https://manpages.debian.org/unstable/gdisk/sgdisk.8.en.html">not in</a> <code>sgdisk</code>, so this command is not easily scriptable. The documentation for <code>gdisk</code> warn that this procedure is <a href="http://www.rodsbooks.com/gdisk/hybrid.html">non-standard, flaky, and unsupported</a>, but this does <em>generally</em> seem to do what is expected. It allows for both BIOS and UEFI booting from the same USB device.</p>

<pre><code>sudo gdisk $disk &lt;&lt; EOF
r     # recovery and transformation options
h     # make hybrid MBR
1 2 3 # partition numbers for hybrid MBR
N     # do not place EFI GPT (0xEE) partition first in MBR
EF    # MBR hex code
N     # do not set bootable flag
EF    # MBR hex code
N     # do not set bootable flag
83    # MBR hex code
Y     # set the bootable flag
x     # extra functionality menu
h     # recompute CHS values in protective/hybrid MBR
w     # write table to disk and exit
Y     # confirm changes
EOF
</code></pre>

<p>Format the UEFI and data partitions.</p>

<pre><code>sudo mkfs.vfat -F32 ${disk}2 &amp;&amp; \
sudo mkfs.vfat -F32 ${disk}3
</code></pre>

<p>Mount the partitions.</p>

<pre><code>sudo mount ${disk}2 /mnt/efi &amp;&amp; \
sudo mount ${disk}3 /mnt/usb
</code></pre>

<p>Install Grub for x86_64 UEFI booting.</p>

<pre><code>sudo grub-install \
    --target=x86_64-efi \
    --efi-directory=/mnt/efi \
    --boot-directory=/mnt/usb/boot \
    --removable \
    --recheck
</code></pre>

<p>Install Grub for i386-pc booting.</p>

<pre><code>sudo grub-install \
    --target=i386-pc \
    --boot-directory=/mnt/usb/boot \
    --recheck \
    $disk
</code></pre>

<p>Create a <code>live</code> directory on the USB device.</p>

<pre><code>sudo mkdir -p /mnt/usb/{boot/grub,live}
</code></pre>

<p>Copy the Debian live environment files we previously generated to the USB disk.</p>

<pre><code>sudo cp -r $HOME/LIVE_BOOT/image/* /mnt/usb/
</code></pre>

<p>Copy the <code>grub.cfg</code> boot configuration to the USB device.</p>

<pre><code>sudo cp \
    $HOME/LIVE_BOOT/scratch/grub.cfg \
    /mnt/usb/boot/grub/grub.cfg
</code></pre>

<p>Now unmount the disk and you should be ready to boot from it on either a BIOS or UEFI system.</p>

<pre><code>sudo umount /mnt/{usb,efi}
</code></pre>

</div>

  </section>
</div>
<script>

document.querySelectorAll('.tabs').forEach(($tabs) => {

    
    $tabs.querySelectorAll('nav div').forEach(($button) => {

        
        $button.addEventListener('click', function () {
            let selectedIndex = 0;

            
            $tabs.querySelectorAll('nav div').forEach(($otherButton, index) => {
                if ($otherButton !== $button) {
                    delete $otherButton.dataset.selected;
                } else {
                    selectedIndex = index;
                    $button.dataset.selected = true;
                }
            });

            
            $tabs.querySelectorAll('.tab').forEach(($otherTab, index) => {
                if (index != selectedIndex) {
                    delete $otherTab.dataset.selected;
                } else {
                    $otherTab.dataset.selected = true;
                }
            });
        });
    });
});
</script>

<div class="accordion">
  <h1 id="notes" class="heading">
    Notes
    <span class="show" data-visible="true">&#43;</span>
    <span class="hide" data-visible="false">&#8722;</span>
  </h1>
  <article data-visible="false">
    <p>Please note that the result of writing an <code>.iso</code> file generated by the <strong>ISO/CD</strong> instructions to a USB device is <strong>not the same</strong> as the other set of instructions for <strong>Direct USB</strong>.</p>

<p>If you write an <code>.iso</code> to a USB device you are deleting all the data (including partitions/filesystem) on that USB device and replacing them with a <strong>read-only</strong> <code>iso9660</code> filesystem, which is normally what we see on CDs! On the other hand, if we use the <strong>Direct USB</strong> instructions, then the USB device will have traditional partitions that we can read from and write to on any standard machine.</p>

<p>Please read in entirety the <a href="https://www.syslinux.org/wiki/index.php?title=Isohybrid">syslinux isohybrid MBR article</a> and the <a href="https://wiki.osdev.org/El-Torito#Hybrid_Setup_for_BIOS_and_EFI_from_CD.2FDVD_and_USB_stick">El-Torito article on Hybrid ISO booting</a> and their related articles. The <a href="https://manpages.debian.org/jessie/xorriso/xorrisofs.1.en.html">Debian xorriso man page</a> has excellent documentation around ISO/USB booting as well.</p>

<p>Syslinux/Isolinux are <a href="https://wiki.osdev.org/El-Torito#Hybrid_Setup_for_BIOS_and_EFI_from_CD.2FDVD_and_USB_stick">more</a>
<a href="https://wiki.archlinux.org/index.php/Remastering_the_Install_ISO#Create_a_new_ISO">commonly</a>
 used when creating an <code>.iso</code> that can also be written directly to USB, but the <a href="https://manpages.debian.org/stretch/xorriso/xorrisofs.1.en.html">Debian xorrisofs docs</a> say the following.</p>

<blockquote>
<p>EFI boot equipment may be combined with above ISOLINUX isohybrid for PC-BIOS in a not really UEFI-2.4 compliant way&hellip;</p>
</blockquote>

<p>I don&rsquo;t like that <code>not really...compliant</code> bit.</p>

<p>Though, the docs also point out that it <em>does</em> work well. However, I&rsquo;m trying to consolidate on Grub to avoid a mix of Syslinux configs/files and Grub commands/files.</p>

<p>Figuring out the right syntax and bootloaders to use for each command was a nightmare, and took a lot of time and reading and trial and error. I realize there are simpler commands like <code>grub-mkrescue</code>, but I wanted to explicitly call out the manual commands used for each process.</p>

<p>The <a href="https://www.gnu.org/software/xorriso/man_1_xorriso.html">GNU xorrisofs docs</a> seem outdated. The <a href="https://manpages.debian.org/stretch/xorriso/xorrisofs.1.en.html">Debian docs</a> were more reliable with better examples.</p>

<p>Examining the <a href="https://github.com/coreos/grub/blob/master/util/grub-mkrescue.c">grub-mkrescue</a> source code and <a href="https://lists.gnu.org/archive/html/bug-xorriso/2015-04/msg00003.html">this xorriso mailing list exchange</a> helped me figure out how to use the <code>--grub2-mbr</code> flag to install the standard MBR bootloader in the <code>.iso</code> file.</p>

<p>Supposedly, we can also use <code>-partition_offset</code> so the <code>.iso</code> can be written to USB to help for natural disk layouts on the USB device, but I could not figure out how to get that working.</p>

<blockquote>
<p>&hellip; facilitates later manipulations of the USB stick by tools for partitioning and formatting&hellip;</p>
</blockquote>

<p>This blurb is confusing, but I realized it means <code>Grub</code> can be used as the boot equipment for a CD in the same way we would use Syslinux with isohybrid MBR entries.</p>

<blockquote>
<p>More compliant with UEFI-2.4 is to decide for either MBR or GPT and to append a copy of the EFI System Partition in order to avoid overlap of ISO partition and EFI partition. Here for MBR:</p>

<pre><code>   -eltorito-alt-boot -e 'boot/grub/efi.img' -no-emul-boot \
   -append_partition 2 0xef ./CD_root/boot/grub/efi.img \
</code></pre>

<p>The resulting ISOs are supposed to boot from optical media and USB stick. One may omit option -eltorito-alt-boot if no option -b is used to make the ISO bootable via PC-BIOS.</p>
</blockquote>

<p>That worked wonderfully for me to get a pure Grub result.</p>

<p>This is a super handy command for examining the commands that may have been used to generate an <code>.iso</code> file.</p>

<pre><code>xorriso -hfsplus on -indev IMAGE.iso \
-report_el_torito plain -report_system_area plain \
-print &quot;&quot; -print &quot;======= Proposal for xorrisofs options:&quot; \
-report_el_torito as_mkisofs
</code></pre>

<p>Figuring out which modules are needed for what behavior is frustrating. There are docs, but they do not seem to easily correlate to &ldquo;this is required to list devices with <code>ls</code>&rdquo; and similar behavior. I eventually found the magic combo for <code>grub-mkstandalone</code>, which cuts down a few steps. Here&rsquo;s how to do it with <code>grub-mkimage</code>. More verbose, but easier to debug.</p>

<p>Create a Grub early config file. Note that the label <code>DEBIAN_CUSTOM</code> matters. We must use the same label on our <code>.iso</code> so that Grub always knows where to find our boot media.</p>

<pre><code>cat &lt;&lt;'EOF' &gt;$HOME/LIVE_BOOT/scratch/embedded.cfg
search --no-floppy --set=root --label DEBIAN_CUSTOM
EOF
</code></pre>

<p>Generate a memdisk ourselves.</p>

<pre><code>tar \
    -C $HOME/LIVE_BOOT/scratch \
    --transform 's;\.;boot/grub;' \
    -cf $HOME/LIVE_BOOT/scratch/memdisk.tar \
    ./grub.cfg
</code></pre>

<p>Bring it all together.</p>

<pre><code>grub-mkimage \
    --directory=/usr/lib/grub/i386-pc \
    --format=i386-pc \
    --prefix=&quot;/boot/grub&quot; \
    --output=$HOME/LIVE_BOOT/scratch/core.img \
    --memdisk=$HOME/LIVE_BOOT/scratch/memdisk.tar \
    --config=$HOME/LIVE_BOOT/scratch/embedded.cfg \
    linux normal iso9660 biosdisk memdisk search tar
</code></pre>

  </article>
</div>


<h1 id="citations">Citations</h1>

<ul>
<li><a href="https://linux.die.net/man/8/sgdisk">sgdisk(8) - Linux man page</a></li>
<li><a href="https://wiki.archlinux.org/index.php/Multiboot_USB_drive#Hybrid_UEFI_GPT_.2B_BIOS_GPT.2FMBR_boot">Hybrid UEFI GPT + BIOS GPT/MBR boot</a></li>
<li><a href="https://wiki.archlinux.org/index.php/GRUB#.22No_suitable_mode_found.22_error">&ldquo;No suitable mode found&rdquo; error</a></li>
<li><a href="https://askubuntu.com/questions/258991/where-is-the-memtest-option-on-the-ubuntu-64-bit-live-cd">Where is the memtest option on the Ubuntu 64-bit live CD?</a></li>
<li><a href="https://wiki.archlinux.org/index.php/Remastering_the_Install_ISO">Remastering the Install ISO</a></li>
<li><a href="https://help.ubuntu.com/community/UEFIBooting#Install_GRUB2_in_.28U.29EFI_systems">Install GRUB2 in (U)EFI systems</a></li>
<li><a href="https://www.gnu.org/software/grub/manual/grub/html_node/Embedded-configuration.html">6.4 Embedding a configuration file into GRUB</a></li>
<li><a href="https://askubuntu.com/questions/643938/standalone-grub2-efi-installation-grub-cfg-placement">Standalone Grub2 EFI installation - grub.cfg placement?</a></li>
<li><a href="https://unix.stackexchange.com/questions/253657/actual-usage-of-grub-mkimage-config">actual usage of &lsquo;grub-mkimage --config= &lsquo;</a></li>
<li><a href="http://lukeluo.blogspot.com/2013/06/grub-how-to-4-memdisk-and-loopback.html">GRUB2 How To (4): memdisk and loopback device</a></li>
<li><a href="https://unix.stackexchange.com/questions/267765/how-does-the-grub-efi-loader-find-the-correct-grub-cfg-and-boot-directory">How does the grub efi loader find the correct grub.cfg and boot directory?</a></li>
<li><a href="https://www.linux.com/learn/how-rescue-non-booting-grub-2-Linux">How to Rescue a Non-booting GRUB 2 on Linux</a></li>
<li><a href="https://help.ubuntu.com/community/BootFromUSB#Using_a_CD">Using a CD</a></li>
<li><a href="https://superuser.com/questions/746553/boot-linux-with-extlinux-from-efi-gpt">Boot Linux with extlinux from EFI &amp; GPT</a></li>
<li><a href="https://blog.fpmurphy.com/2010/06/grub2-modules.html">GRUB2 Modules</a></li>
<li><a href="https://github.com/coreos/grub/blob/master/util/grub-install.c">grub-install.c</a></li>
<li><a href="https://help.ubuntu.com/community/Grub2/Troubleshooting">Grub2/Troubleshooting</a></li>
<li><a href="https://wiki.archlinux.org/index.php/Secure_Boot#Set_up_PreLoader">Set up PreLoader</a></li>
<li><a href="https://wiki.archlinux.org/index.php/REFInd#Using_PreLoader">Using PreLoader</a></li>
<li><a href="https://github.com/Mic92/archlive/blob/master/build.sh#L138">build.sh</a></li>
<li><a href="https://wiki.archlinux.org/index.php/archiso#Installing_packages_from_multilib">Archiso</a></li>
<li><a href="https://www.syslinux.org/wiki/index.php?title=Menu#The_simple_menu_system">The simple menu system</a></li>
<li><a href="https://www.syslinux.org/wiki/index.php?title=Isohybrid#UEFI">UEFI</a></li>
<li><a href="https://www.linuxquestions.org/questions/linux-general-1/make-uefi-bootable-live-cd-926021/">Make UEFI bootable live CD</a></li>
<li><a href="https://unix.stackexchange.com/questions/285193/what-is-the-proper-way-to-use-isolinux-with-uefi">What is the proper way to use ISOLINUX with UEFI?</a></li>
<li><a href="https://wiki.debian.org/UEFI#Booting_from_removable_media">Booting from removable media</a></li>
<li><a href="https://wiki.archlinux.org/index.php/GRUB#UEFI_systems">UEFI systems</a></li>
<li><a href="https://www.rodsbooks.com/efi-bootloaders/installation.html">Managing EFI Boot Loaders for Linux: EFI Boot Loader Installation</a></li>
<li><a href="https://wiki.archlinux.org/index.php/syslinux#Boot_prompt">Examples</a></li>
<li><a href="https://forum.osdev.org/viewtopic.php?t=22169&amp;p=178135">Grub2 El-Torito CD</a></li>
<li><a href="https://forum.osdev.org/viewtopic.php?f=1&amp;t=23766">Create ISO image with GRUB2</a></li>
<li><a href="https://wiki.debian.org/DebianLive/MultibootISO">DebianLive MultibootISO</a></li>
<li><a href="https://www.gnu.org/software/grub/manual/grub/html_node/Images.html">11 GRUB image files</a></li>
<li><a href="https://www.linuxquestions.org/questions/linux-software-2/stage2_eltorito-missing-884944/">stage2_eltorito missing</a></li>
<li><a href="https://www.gnu.org/software/grub/manual/legacy/Making-a-GRUB-bootable-CD_002dROM.html">3.4 Making a GRUB bootable CD-ROM</a></li>
<li><a href="https://unix.stackexchange.com/questions/283994/why-is-grub2-ignoring-kernel-options-when-boot-from-el-torito-on-cd">why is grub2 ignoring kernel options when boot from el torito on CD?</a></li>
<li><a href="https://communities.vmware.com/message/2228281#2228281">Boot UEFI does not work from CD/DVD</a></li>
<li><a href="https://communities.vmware.com/message/2583742#2583742">UEFI problem after upgrading to VMWS player 12</a></li>
<li><a href="https://github.com/linuxkit/linuxkit/blob/master/tools/mkimage-iso-efi/make-efi">make-efi</a></li>
<li><a href="https://unix.stackexchange.com/questions/382817/uefi-bios-bootable-live-debian-stretch-amd64-with-persistence">UEFI + BIOS bootable live Debian stretch amd64 with persistence</a></li>
<li><a href="https://www.syslinux.org/archives/2015-April/023381.html">[syslinux] Isohybrid wiki page and UEFI</a></li>
</ul>

  </div>

  <div class="feedback">Feel free to <a target="_blank" href="https://twitter.com/messages/compose?recipient_id=142425885&amp;text=Regarding%20article%20http%3a%2f%2fwillhaley.com%2fblog%2fcustom-debian-live-environment%2f%0a%0a">contact me</a> with questions or feedback regarding this article.</div>
  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "willhaley" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</article>

    </div>
  </main>

  <footer class="site-footer">
    <div class="wrapper">

      <h2 class="footer-heading">Will Haley</h2>

      <div class="footer-col-wrapper">
        <div class="footer-col footer-col-1">
          <ul class="contact-list">
            <li>Will Haley</li>
            <li><a href="mailto:"></a></li>
          </ul>
        </div>

        <div class="footer-col footer-col-2">
          <ul class="social-media-list">

            <li>
              <a href="https://github.com/williamhaley"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
  </span><span class="username">williamhaley</span></a>
            </li>
          </ul>
        </div>

        <div class="footer-col footer-col-3">
          <p></p>
        </div>
      </div>
    </div>
  </footer>

  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-16792239-1', 'auto');
	
	ga('send', 'pageview');
}
</script>


  <script src="/js/custom.js?version=1.1.6"></script>
</body>
</html>